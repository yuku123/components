# 电商数据库的设计和架构优化

## 第一章 1-4

1. 数据结构设计

    - 逻辑设计+物理设计

2. 数据库设计方案

    - 数据库命名规范
    - 数据库基本设计方案
    - 数据库索引设计规范
    - 数据库字段设计规范
    - 数据库sql开发规范
    - 数据库操作行为规范

## 第一章 5-7

1. 必须使用小写字母并用下划线分割
2. 禁止使用保留关键字
3. 不能超过32个字符
4. 临时表必须以tmp为前缀，以日期为后缀
5. 备份库，必须以bak为前缀并且以时间为后缀
6. 不同表内同名的字段必须列类型一致
7. mysql5.5 之前 为Myisam存储引擎，但是都应该为Innodb存储引擎，支持事务，行锁，更好的恢复性，高并发下性能更好
8. 数据库与表的字符集统一，建议使用utf-8，GBK,GB1312
9. 所有表和字段都需要添加注释
10. 尽量控制数据量的大小，500万之内，谨慎使用mysql分区表，谨慎选择分区键，尽量避免跨分区查询，建议采用物理分区表
11. 尽量做到冷热数据分离，减少表的宽度，最多4096列，减少磁盘IO,保证热数据的内存缓存命中率，利用更有效的利用缓存，避免读入无用的冷数据，把经常使用的列放到一个表内
12. 禁止在表中建立预留字段
13. 禁止存储图片，文件等二进制数据
14. 禁止在线上数据库压力测试
15. 禁止从开发环境，测试环境连接线上环境数据库

16. 限制每张表上的索引数量数量，建议单张表的索引不超过5个
17. 禁止给表中的每一列都建立独立的索引
18. 每个Innodb表必须有一个主键，不然就打头非空唯一的列为主键，如果没有的话，就会自动生成一个主键（性能是很差的）
19. 不使用更新频繁的列作为主键，不使用多列主键
20. 不使用 uuid md5 hash 字符串 列为主键
21. 常见的索引列建议：包含在group by , order by distinct 中的列
22. 索引列的顺序：区分度最高的列放在联合索引的最左侧，把字段长度小的列放在联合索引的最左侧，把使用最频繁的列放在最左侧
23. 避免建立冗余，重复的索引： primary(id),index(id),unique index(id)
24. 对于频繁的查询优先考虑使用覆盖索引，避免Innodb 表进行索引的二次查找，将随机io变为顺序io加快查询效率

25. 优先选择符合存储的最小的数据类型--> 对ip有 inet_aton
26. 非负值则选择非负类型存储
27. varchar(n)为字符数量，不是字节数
28. 避免text和blob，enum数据类型
29. 尽可能把所有的列定义为not null
30. 不建议使用字符串存储日期型数据，需要使用timestamp与datetime
31. 金融计算必须使用decimal

32. 建议使用预编译语句进行数据库操作
33. 避免隐士的数据转换，where id = '1'

34. 避免使用子查询，可以把子查询优化为join
35. 使用in 代替or
36. 禁止使用order by rand() 进行随机排序
37. 不能在where条件内进行函数转换，会导致索引没有办法使用
38. 使用union all
39. 拆分复杂的大sql与多个小sql

40. 数据需要批量进行写操作，进行分批次多次进行操作，避免产生大事务操作
41. 对于修改大表，需要pt_online-schema-change
42. 禁止为程序使用账号赋予super权限，不允许跨库操作，不准许有drop权限

## 第二章


### 分区

1. hash分区，列必须是int
2. range 分区,使用日期，时间类型
````
partition by range(customer_id)（
   partition p0 values less than (100000),
   ~~maxvalue 
）
````

3. list分区
 ````
 partition by range(customer_id)（
    partition p0 values in (100000,1,2,3),
    ~~maxvalue 
 ）
 ````